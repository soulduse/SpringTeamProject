<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="Data">
   <typeAlias alias="bbsView" type="com.listen.bbs.vo.BbsVo" />
   <typeAlias alias="bbsLikeSwitchDto" type="com.listen.bbs.dto.BbsLikeSwitchDto" />
   <typeAlias alias="bbsViewFilterDto" type="com.listen.bbs.dto.BbsViewFilterDto" />
   
   <typeAlias alias="ynFilterVo" type="com.listen.bbs.vo.YnFilterVo" />
   <typeAlias alias="bbsSelectViewVo" type="com.listen.bbs.vo.BbsSelectViewVo" />

   <select id="bbsViewList" resultClass="bbsView" >
      SELECT A.BBS_SEQ, A.BG_IMG_SEQ, A.BBS_CONTENTS, A.BBS_HITCOUNT, A.GOODCOUNT, A.REG_EMAIL, B.PATH, B.SAVE_NAME
      FROM BBS A, BACKGROUND_IMG B
      WHERE A.DISPYN='Y'AND A.BG_IMG_SEQ = B.BG_IMG_SEQ
      ORDER BY A.BBS_SEQ DESC
   </select>
   
   <!-- 글보기시 YN_FILTER INSERT Query -->
   <insert id="bbsViewInsertFilter" parameterClass="bbsViewFilterDto">
      INSERT INTO YN_FILTER 
      (FILTER_SEQ, BBS_SEQ, MEMBERS_SEQ)
      VALUES
      (FILTER_SEQ.NEXTVAL, #bbs_seq#, (SELECT MEMBERS_SEQ FROM MEMBERS WHERE EMAIL=#email#))
   </insert>
   
   <!-- 글보기 INSERT 전 Query -->
   <update id="bbsViewSelectFilter" parameterClass="bbsViewFilterDto">
   		UPDATE YN_FILTER SET
   		BBS_SEQ
   
   </update>
   
   <!-- 글을 볼때 Ajax 형식으로 데이터 가져오기 -->
   <select id="bbsSelectView" resultClass="bbsSelectViewVo" parameterClass="bbsViewFilterDto">
   		SELECT 
   		FROM BBS
   </select>
   
   <select id="bbsDetailView" resultClass="bbsView" parameterClass="bbsView">
      <dynamic>
      <isEqual property="selectItem" compareValue="댓글">
         SELECT A.BBS_SEQ, A.BG_IMG_SEQ, A.BBS_CONTENTS, A.REG_EMAIL, A.BBS_HITCOUNT, A.GOODCOUNT, A.MEMBERS_SEQ, B.ADD_COUNT, C.PATH, C.SAVE_NAME
         FROM BBS A, (SELECT BBS_SEQ, COUNT(*) ADD_COUNT FROM BBS_ADD GROUP BY BBS_SEQ ) B, BACKGROUND_IMG C
         WHERE A.BBS_SEQ = B.BBS_SEQ AND A.DISPYN='Y'AND A.BG_IMG_SEQ = C.BG_IMG_SEQ
         ORDER BY ADD_COUNT DESC 
      </isEqual>
      </dynamic>      
      <dynamic>
      <isEqual property="selectItem" compareValue="goodCount">
      SELECT A.BBS_SEQ, A.BG_IMG_SEQ, A.BBS_CONTENTS, A.BBS_HITCOUNT, A.REG_EMAIL, B.PATH, B.SAVE_NAME, A.GOODCOUNT, c.add_count
         FROM BBS A, BACKGROUND_IMG B,(SELECT BBS_SEQ, COUNT(*) ADD_COUNT FROM BBS_ADD GROUP BY BBS_SEQ ) c
         WHERE A.DISPYN='Y'AND A.BG_IMG_SEQ = B.BG_IMG_SEQ and a.bbs_seq = c.bbs_seq(+)
         ORDER BY a.GOODCOUNT DESC
      </isEqual>
      </dynamic>
      <dynamic>
      <isEqual property="selectItem" compareValue="bbs_hitCount">
            SELECT A.BBS_SEQ, A.BG_IMG_SEQ, A.BBS_CONTENTS, A.BBS_HITCOUNT, A.REG_EMAIL, B.PATH, B.SAVE_NAME, A.GOODCOUNT, c.add_count 
         FROM BBS A, BACKGROUND_IMG B,(SELECT BBS_SEQ, COUNT(*) ADD_COUNT FROM BBS_ADD GROUP BY BBS_SEQ ) c
         WHERE A.DISPYN='Y'AND A.BG_IMG_SEQ = B.BG_IMG_SEQ and a.bbs_seq = c.bbs_seq(+)
            ORDER BY a.bbs_hitcount DESC
      </isEqual>
      </dynamic>
       <dynamic>
      <isEqual property="selectItem" compareValue="main">
            SELECT A.BBS_SEQ, A.BG_IMG_SEQ, A.BBS_CONTENTS, A.BBS_HITCOUNT, A.GOODCOUNT, A.REG_EMAIL, B.PATH, B.SAVE_NAME
            FROM BBS A, BACKGROUND_IMG B
            WHERE A.DISPYN='Y'AND A.BG_IMG_SEQ = B.BG_IMG_SEQ
            ORDER BY A.BBS_SEQ DESC
      </isEqual>
      </dynamic>
   </select>
   
   <!-- 글공감 Like Update 처리 #1 -->
   <update id="likeCountUpdate" parameterClass="bbsLikeSwitchDto">
      UPDATE BBS SET
      GOODCOUNT = #likeValue#
      WHERE BBS_SEQ = #bbs_seq#
   </update>
   
   <!-- 글 공감 INSERT 전 UPDATE를 통한 YNFILTER CHECK -->
   <update id="checkYnFilter" parameterClass="bbsLikeSwitchDto">
   		UPDATE YN_FILTER SET
   		<dynamic>
   			<isEqual property="bbs_good_yn" compareValue="Y">
		   		BBS_GOOD_YN = 'Y'
   			</isEqual>
   			<isEqual property="bbs_good_yn" compareValue="N">
		   		BBS_GOOD_YN = 'N'
   			</isEqual>
   		</dynamic>
   		WHERE BBS_SEQ = #bbs_seq# 	AND 
   		MEMBERS_SEQ = (SELECT MEMBERS_SEQ FROM MEMBERS WHERE EMAIL=#reg_email#)
   </update>
   
   <!-- 글공감 Like Update 처리 #2 -->
   <insert id="BbsLikeYnFilter" parameterClass="bbsLikeSwitchDto">
   		INSERT INTO YN_FILTER
   		(FILTER_SEQ, BBS_SEQ, MEMBERS_SEQ, BBS_GOOD_YN)
   		VALUES
   		(FILTER_SEQ.NEXTVAL, #bbs_seq#, 
   		(SELECT MEMBERS_SEQ FROM MEMBERS WHERE EMAIL=#reg_email#),
   		#bbs_good_yn#)
   </insert>
   
</sqlMap>

